{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Rによるメールマーケティングの効果の検証"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## RCTされているデータの場合"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "The downloaded binary packages are in\n",
      "\t/var/folders/rr/fb4bmjkj789czq2w91y81l480000gn/T//RtmpZOzec6/downloaded_packages\n"
     ]
    }
   ],
   "source": [
    "# パッケージのインストール\n",
    "install.packages(\"tidyverse\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "─ \u001b[1mAttaching packages\u001b[22m ──────────────────── tidyverse 1.3.1 ─\n",
      "\n",
      "\u001b[32m✔\u001b[39m \u001b[34mggplot2\u001b[39m 3.3.3     \u001b[32m✔\u001b[39m \u001b[34mpurrr  \u001b[39m 0.3.4\n",
      "\u001b[32m✔\u001b[39m \u001b[34mtibble \u001b[39m 3.1.0     \u001b[32m✔\u001b[39m \u001b[34mdplyr  \u001b[39m 1.0.5\n",
      "\u001b[32m✔\u001b[39m \u001b[34mtidyr  \u001b[39m 1.1.3     \u001b[32m✔\u001b[39m \u001b[34mstringr\u001b[39m 1.4.0\n",
      "\u001b[32m✔\u001b[39m \u001b[34mreadr  \u001b[39m 1.4.0     \u001b[32m✔\u001b[39m \u001b[34mforcats\u001b[39m 0.5.1\n",
      "\n",
      "─ \u001b[1mConflicts\u001b[22m ───────────────────── tidyverse_conflicts() ─\n",
      "\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mfilter()\u001b[39m masks \u001b[34mstats\u001b[39m::filter()\n",
      "\u001b[31m✖\u001b[39m \u001b[34mdplyr\u001b[39m::\u001b[32mlag()\u001b[39m    masks \u001b[34mstats\u001b[39m::lag()\n",
      "\n"
     ]
    }
   ],
   "source": [
    "library(\"tidyverse\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\n",
      "\u001b[36m─\u001b[39m \u001b[1m\u001b[1mColumn specification\u001b[1m\u001b[22m \u001b[36m────────────────────────────\u001b[39m\n",
      "cols(\n",
      "  recency = \u001b[32mcol_double()\u001b[39m,\n",
      "  history_segment = \u001b[31mcol_character()\u001b[39m,\n",
      "  history = \u001b[32mcol_double()\u001b[39m,\n",
      "  mens = \u001b[32mcol_double()\u001b[39m,\n",
      "  womens = \u001b[32mcol_double()\u001b[39m,\n",
      "  zip_code = \u001b[31mcol_character()\u001b[39m,\n",
      "  newbie = \u001b[32mcol_double()\u001b[39m,\n",
      "  channel = \u001b[31mcol_character()\u001b[39m,\n",
      "  segment = \u001b[31mcol_character()\u001b[39m,\n",
      "  visit = \u001b[32mcol_double()\u001b[39m,\n",
      "  conversion = \u001b[32mcol_double()\u001b[39m,\n",
      "  spend = \u001b[32mcol_double()\u001b[39m\n",
      ")\n",
      "\n",
      "\n"
     ]
    }
   ],
   "source": [
    "email_data <- read_csv(\"http://www.minethatdata.com/Kevin_Hillstrom_MineThatData_E-MailAnalytics_DataMiningChallenge_2008.03.20.csv\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [],
   "source": [
    "male_df <- email_data %>% filter(segment != \"Womens E-Mail\") %>%\n",
    "mutate(treatment = if_else(segment == \"Mens E-Mail\", 1, 0))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 5 × 13</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>recency</th><th scope=col>history_segment</th><th scope=col>history</th><th scope=col>mens</th><th scope=col>womens</th><th scope=col>zip_code</th><th scope=col>newbie</th><th scope=col>channel</th><th scope=col>segment</th><th scope=col>visit</th><th scope=col>conversion</th><th scope=col>spend</th><th scope=col>treatment</th></tr>\n",
       "\t<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>6</td><td>3) $200 - $350</td><td>329.08</td><td>1</td><td>1</td><td>Rural</td><td>1</td><td>Web         </td><td>No E-Mail  </td><td>0</td><td>0</td><td>0</td><td>0</td></tr>\n",
       "\t<tr><td>9</td><td>5) $500 - $750</td><td>675.83</td><td>1</td><td>0</td><td>Rural</td><td>1</td><td>Web         </td><td>Mens E-Mail</td><td>0</td><td>0</td><td>0</td><td>1</td></tr>\n",
       "\t<tr><td>9</td><td>5) $500 - $750</td><td>675.07</td><td>1</td><td>1</td><td>Rural</td><td>1</td><td>Phone       </td><td>Mens E-Mail</td><td>0</td><td>0</td><td>0</td><td>1</td></tr>\n",
       "\t<tr><td>2</td><td>2) $100 - $200</td><td>101.64</td><td>0</td><td>1</td><td>Urban</td><td>0</td><td>Web         </td><td>Mens E-Mail</td><td>1</td><td>0</td><td>0</td><td>1</td></tr>\n",
       "\t<tr><td>4</td><td>3) $200 - $350</td><td>241.42</td><td>0</td><td>1</td><td>Rural</td><td>1</td><td>Multichannel</td><td>No E-Mail  </td><td>0</td><td>0</td><td>0</td><td>0</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 5 × 13\n",
       "\\begin{tabular}{lllllllllllll}\n",
       " recency & history\\_segment & history & mens & womens & zip\\_code & newbie & channel & segment & visit & conversion & spend & treatment\\\\\n",
       " <dbl> & <chr> & <dbl> & <dbl> & <dbl> & <chr> & <dbl> & <chr> & <chr> & <dbl> & <dbl> & <dbl> & <dbl>\\\\\n",
       "\\hline\n",
       "\t 6 & 3) \\$200 - \\$350 & 329.08 & 1 & 1 & Rural & 1 & Web          & No E-Mail   & 0 & 0 & 0 & 0\\\\\n",
       "\t 9 & 5) \\$500 - \\$750 & 675.83 & 1 & 0 & Rural & 1 & Web          & Mens E-Mail & 0 & 0 & 0 & 1\\\\\n",
       "\t 9 & 5) \\$500 - \\$750 & 675.07 & 1 & 1 & Rural & 1 & Phone        & Mens E-Mail & 0 & 0 & 0 & 1\\\\\n",
       "\t 2 & 2) \\$100 - \\$200 & 101.64 & 0 & 1 & Urban & 0 & Web          & Mens E-Mail & 1 & 0 & 0 & 1\\\\\n",
       "\t 4 & 3) \\$200 - \\$350 & 241.42 & 0 & 1 & Rural & 1 & Multichannel & No E-Mail   & 0 & 0 & 0 & 0\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 5 × 13\n",
       "\n",
       "| recency &lt;dbl&gt; | history_segment &lt;chr&gt; | history &lt;dbl&gt; | mens &lt;dbl&gt; | womens &lt;dbl&gt; | zip_code &lt;chr&gt; | newbie &lt;dbl&gt; | channel &lt;chr&gt; | segment &lt;chr&gt; | visit &lt;dbl&gt; | conversion &lt;dbl&gt; | spend &lt;dbl&gt; | treatment &lt;dbl&gt; |\n",
       "|---|---|---|---|---|---|---|---|---|---|---|---|---|\n",
       "| 6 | 3) $200 - $350 | 329.08 | 1 | 1 | Rural | 1 | Web          | No E-Mail   | 0 | 0 | 0 | 0 |\n",
       "| 9 | 5) $500 - $750 | 675.83 | 1 | 0 | Rural | 1 | Web          | Mens E-Mail | 0 | 0 | 0 | 1 |\n",
       "| 9 | 5) $500 - $750 | 675.07 | 1 | 1 | Rural | 1 | Phone        | Mens E-Mail | 0 | 0 | 0 | 1 |\n",
       "| 2 | 2) $100 - $200 | 101.64 | 0 | 1 | Urban | 0 | Web          | Mens E-Mail | 1 | 0 | 0 | 1 |\n",
       "| 4 | 3) $200 - $350 | 241.42 | 0 | 1 | Rural | 1 | Multichannel | No E-Mail   | 0 | 0 | 0 | 0 |\n",
       "\n"
      ],
      "text/plain": [
       "  recency history_segment history mens womens zip_code newbie channel     \n",
       "1 6       3) $200 - $350  329.08  1    1      Rural    1      Web         \n",
       "2 9       5) $500 - $750  675.83  1    0      Rural    1      Web         \n",
       "3 9       5) $500 - $750  675.07  1    1      Rural    1      Phone       \n",
       "4 2       2) $100 - $200  101.64  0    1      Urban    0      Web         \n",
       "5 4       3) $200 - $350  241.42  0    1      Rural    1      Multichannel\n",
       "  segment     visit conversion spend treatment\n",
       "1 No E-Mail   0     0          0     0        \n",
       "2 Mens E-Mail 0     0          0     1        \n",
       "3 Mens E-Mail 0     0          0     1        \n",
       "4 Mens E-Mail 1     0          0     1        \n",
       "5 No E-Mail   0     0          0     0        "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "male_df %>% head(5)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [],
   "source": [
    "summary_by_segment <- male_df %>%\n",
    "group_by(treatment) %>%\n",
    "summarise(\n",
    "    conversion_rate = mean(conversion),\n",
    "    spend_mean = mean(spend),\n",
    "    count = n()\n",
    "         )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>treatment</th><th scope=col>conversion_rate</th><th scope=col>spend_mean</th><th scope=col>count</th></tr>\n",
       "\t<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>0</td><td>0.005726087</td><td>0.6527894</td><td>21306</td></tr>\n",
       "\t<tr><td>1</td><td>0.012531093</td><td>1.4226165</td><td>21307</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 4\n",
       "\\begin{tabular}{llll}\n",
       " treatment & conversion\\_rate & spend\\_mean & count\\\\\n",
       " <dbl> & <dbl> & <dbl> & <int>\\\\\n",
       "\\hline\n",
       "\t 0 & 0.005726087 & 0.6527894 & 21306\\\\\n",
       "\t 1 & 0.012531093 & 1.4226165 & 21307\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 4\n",
       "\n",
       "| treatment &lt;dbl&gt; | conversion_rate &lt;dbl&gt; | spend_mean &lt;dbl&gt; | count &lt;int&gt; |\n",
       "|---|---|---|---|\n",
       "| 0 | 0.005726087 | 0.6527894 | 21306 |\n",
       "| 1 | 0.012531093 | 1.4226165 | 21307 |\n",
       "\n"
      ],
      "text/plain": [
       "  treatment conversion_rate spend_mean count\n",
       "1 0         0.005726087     0.6527894  21306\n",
       "2 1         0.012531093     1.4226165  21307"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "summary_by_segment"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [],
   "source": [
    "mens_mail <- male_df %>%\n",
    "    filter(treatment == 1) %>%\n",
    "    pull(spend)\n",
    "\n",
    "no_mail <- male_df %>%\n",
    "    filter(treatment == 0) %>%\n",
    "    pull(spend)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [],
   "source": [
    "# 平均の差を検定\n",
    "rct_ttest <- t.test(mens_mail, no_mail, var.equal = TRUE)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "\tTwo Sample t-test\n",
       "\n",
       "data:  mens_mail and no_mail\n",
       "t = 5.3001, df = 42611, p-value = 1.163e-07\n",
       "alternative hypothesis: true difference in means is not equal to 0\n",
       "95 percent confidence interval:\n",
       " 0.4851384 1.0545160\n",
       "sample estimates:\n",
       "mean of x mean of y \n",
       "1.4226165 0.6527894 \n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "rct_ttest"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "しっかりとRCTされている場合はP値も小さいので統計的に有意な差があると言える。"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## バイアスのあるデータの効果検証"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [],
   "source": [
    "set.seed(1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "metadata": {},
   "outputs": [],
   "source": [
    "obs_rate_c <- 0.5\n",
    "obs_rate_t <- 0.5\n",
    "biased_data <- male_df %>% \n",
    "    mutate(\n",
    "        obs_rate_c = if_else(\n",
    "            (history > 300) | (recency < 6) | (channel == \"Multichannel\"),\n",
    "            obs_rate_c, 1\n",
    "        ),\n",
    "        obs_rate_t = if_else(\n",
    "            (history > 300) | (recency < 6) | (channel == \"Multichannel\"),\n",
    "            1, obs_rate_t\n",
    "        ),\n",
    "        random_number = runif(n = NROW(male_df))\n",
    "    ) %>%\n",
    "    filter(\n",
    "        (treatment == 0 & random_number < obs_rate_c) | (treatment == 1 & random_number < obs_rate_t)\n",
    "          )"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 5 × 16</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>recency</th><th scope=col>history_segment</th><th scope=col>history</th><th scope=col>mens</th><th scope=col>womens</th><th scope=col>zip_code</th><th scope=col>newbie</th><th scope=col>channel</th><th scope=col>segment</th><th scope=col>visit</th><th scope=col>conversion</th><th scope=col>spend</th><th scope=col>treatment</th><th scope=col>obs_rate_c</th><th scope=col>obs_rate_t</th><th scope=col>random_number</th></tr>\n",
       "\t<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>6</td><td>3) $200 - $350</td><td>329.08</td><td>1</td><td>1</td><td>Rural    </td><td>1</td><td>Web  </td><td>No E-Mail  </td><td>0</td><td>0</td><td>0</td><td>0</td><td>0.5</td><td>1</td><td>0.3974271</td></tr>\n",
       "\t<tr><td>9</td><td>5) $500 - $750</td><td>675.83</td><td>1</td><td>0</td><td>Rural    </td><td>1</td><td>Web  </td><td>Mens E-Mail</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0.5</td><td>1</td><td>0.8173950</td></tr>\n",
       "\t<tr><td>9</td><td>5) $500 - $750</td><td>675.07</td><td>1</td><td>1</td><td>Rural    </td><td>1</td><td>Phone</td><td>Mens E-Mail</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0.5</td><td>1</td><td>0.7874897</td></tr>\n",
       "\t<tr><td>2</td><td>2) $100 - $200</td><td>101.64</td><td>0</td><td>1</td><td>Urban    </td><td>0</td><td>Web  </td><td>Mens E-Mail</td><td>1</td><td>0</td><td>0</td><td>1</td><td>0.5</td><td>1</td><td>0.6273674</td></tr>\n",
       "\t<tr><td>5</td><td>1) $0 - $100  </td><td> 29.99</td><td>1</td><td>0</td><td>Surburban</td><td>0</td><td>Phone</td><td>Mens E-Mail</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0.5</td><td>1</td><td>0.3254771</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 5 × 16\n",
       "\\begin{tabular}{llllllllllllllll}\n",
       " recency & history\\_segment & history & mens & womens & zip\\_code & newbie & channel & segment & visit & conversion & spend & treatment & obs\\_rate\\_c & obs\\_rate\\_t & random\\_number\\\\\n",
       " <dbl> & <chr> & <dbl> & <dbl> & <dbl> & <chr> & <dbl> & <chr> & <chr> & <dbl> & <dbl> & <dbl> & <dbl> & <dbl> & <dbl> & <dbl>\\\\\n",
       "\\hline\n",
       "\t 6 & 3) \\$200 - \\$350 & 329.08 & 1 & 1 & Rural     & 1 & Web   & No E-Mail   & 0 & 0 & 0 & 0 & 0.5 & 1 & 0.3974271\\\\\n",
       "\t 9 & 5) \\$500 - \\$750 & 675.83 & 1 & 0 & Rural     & 1 & Web   & Mens E-Mail & 0 & 0 & 0 & 1 & 0.5 & 1 & 0.8173950\\\\\n",
       "\t 9 & 5) \\$500 - \\$750 & 675.07 & 1 & 1 & Rural     & 1 & Phone & Mens E-Mail & 0 & 0 & 0 & 1 & 0.5 & 1 & 0.7874897\\\\\n",
       "\t 2 & 2) \\$100 - \\$200 & 101.64 & 0 & 1 & Urban     & 0 & Web   & Mens E-Mail & 1 & 0 & 0 & 1 & 0.5 & 1 & 0.6273674\\\\\n",
       "\t 5 & 1) \\$0 - \\$100   &  29.99 & 1 & 0 & Surburban & 0 & Phone & Mens E-Mail & 0 & 0 & 0 & 1 & 0.5 & 1 & 0.3254771\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 5 × 16\n",
       "\n",
       "| recency &lt;dbl&gt; | history_segment &lt;chr&gt; | history &lt;dbl&gt; | mens &lt;dbl&gt; | womens &lt;dbl&gt; | zip_code &lt;chr&gt; | newbie &lt;dbl&gt; | channel &lt;chr&gt; | segment &lt;chr&gt; | visit &lt;dbl&gt; | conversion &lt;dbl&gt; | spend &lt;dbl&gt; | treatment &lt;dbl&gt; | obs_rate_c &lt;dbl&gt; | obs_rate_t &lt;dbl&gt; | random_number &lt;dbl&gt; |\n",
       "|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|\n",
       "| 6 | 3) $200 - $350 | 329.08 | 1 | 1 | Rural     | 1 | Web   | No E-Mail   | 0 | 0 | 0 | 0 | 0.5 | 1 | 0.3974271 |\n",
       "| 9 | 5) $500 - $750 | 675.83 | 1 | 0 | Rural     | 1 | Web   | Mens E-Mail | 0 | 0 | 0 | 1 | 0.5 | 1 | 0.8173950 |\n",
       "| 9 | 5) $500 - $750 | 675.07 | 1 | 1 | Rural     | 1 | Phone | Mens E-Mail | 0 | 0 | 0 | 1 | 0.5 | 1 | 0.7874897 |\n",
       "| 2 | 2) $100 - $200 | 101.64 | 0 | 1 | Urban     | 0 | Web   | Mens E-Mail | 1 | 0 | 0 | 1 | 0.5 | 1 | 0.6273674 |\n",
       "| 5 | 1) $0 - $100   |  29.99 | 1 | 0 | Surburban | 0 | Phone | Mens E-Mail | 0 | 0 | 0 | 1 | 0.5 | 1 | 0.3254771 |\n",
       "\n"
      ],
      "text/plain": [
       "  recency history_segment history mens womens zip_code  newbie channel\n",
       "1 6       3) $200 - $350  329.08  1    1      Rural     1      Web    \n",
       "2 9       5) $500 - $750  675.83  1    0      Rural     1      Web    \n",
       "3 9       5) $500 - $750  675.07  1    1      Rural     1      Phone  \n",
       "4 2       2) $100 - $200  101.64  0    1      Urban     0      Web    \n",
       "5 5       1) $0 - $100     29.99  1    0      Surburban 0      Phone  \n",
       "  segment     visit conversion spend treatment obs_rate_c obs_rate_t\n",
       "1 No E-Mail   0     0          0     0         0.5        1         \n",
       "2 Mens E-Mail 0     0          0     1         0.5        1         \n",
       "3 Mens E-Mail 0     0          0     1         0.5        1         \n",
       "4 Mens E-Mail 1     0          0     1         0.5        1         \n",
       "5 Mens E-Mail 0     0          0     1         0.5        1         \n",
       "  random_number\n",
       "1 0.3974271    \n",
       "2 0.8173950    \n",
       "3 0.7874897    \n",
       "4 0.6273674    \n",
       "5 0.3254771    "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "biased_data %>% head(5)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 4</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>treatment</th><th scope=col>conversion_rate</th><th scope=col>spend_mean</th><th scope=col>count</th></tr>\n",
       "\t<tr><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;int&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>0</td><td>0.005084056</td><td>0.5893892</td><td>14752</td></tr>\n",
       "\t<tr><td>1</td><td>0.013014298</td><td>1.4850913</td><td>17135</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 4\n",
       "\\begin{tabular}{llll}\n",
       " treatment & conversion\\_rate & spend\\_mean & count\\\\\n",
       " <dbl> & <dbl> & <dbl> & <int>\\\\\n",
       "\\hline\n",
       "\t 0 & 0.005084056 & 0.5893892 & 14752\\\\\n",
       "\t 1 & 0.013014298 & 1.4850913 & 17135\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 4\n",
       "\n",
       "| treatment &lt;dbl&gt; | conversion_rate &lt;dbl&gt; | spend_mean &lt;dbl&gt; | count &lt;int&gt; |\n",
       "|---|---|---|---|\n",
       "| 0 | 0.005084056 | 0.5893892 | 14752 |\n",
       "| 1 | 0.013014298 | 1.4850913 | 17135 |\n",
       "\n"
      ],
      "text/plain": [
       "  treatment conversion_rate spend_mean count\n",
       "1 0         0.005084056     0.5893892  14752\n",
       "2 1         0.013014298     1.4850913  17135"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "summary_by_segment_biased <- biased_data %>%\n",
    "    group_by(treatment) %>% \n",
    "    summarise(conversion_rate = mean(conversion),\n",
    "              spend_mean = mean(spend),\n",
    "              count = n()\n",
    "             )\n",
    "summary_by_segment_biased"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "\tTwo Sample t-test\n",
       "\n",
       "data:  mens_mail_biased and no_mail_biased\n",
       "t = 5.2814, df = 31885, p-value = 1.29e-07\n",
       "alternative hypothesis: true difference in means is not equal to 0\n",
       "95 percent confidence interval:\n",
       " 0.5632905 1.2281137\n",
       "sample estimates:\n",
       "mean of x mean of y \n",
       "1.4850913 0.5893892 \n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "mens_mail_biased <- biased_data %>%\n",
    "    filter(treatment == 1) %>%\n",
    "    pull(spend)\n",
    "\n",
    "no_mail_biased <- biased_data %>%\n",
    "    filter(treatment == 0) %>%\n",
    "    pull(spend)\n",
    "\n",
    "rct_ttest_biased <- t.test(mens_mail_biased, no_mail_biased, var.equal = T)\n",
    "rct_ttest_biased"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 回帰分析の導入\n",
    "$$\n",
    "Spend_i = \\beta_0 + \\beta_{treatment}treatment_{i} + \\beta_{history}history_{i}\n",
    "$$"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "metadata": {},
   "outputs": [],
   "source": [
    "biased_reg <- lm(data = biased_data, formula = spend ~ treatment + history)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "\n",
       "Call:\n",
       "lm(formula = spend ~ treatment + history, data = biased_data)\n",
       "\n",
       "Residuals:\n",
       "   Min     1Q Median     3Q    Max \n",
       " -5.39  -1.41  -1.16  -0.50 497.81 \n",
       "\n",
       "Coefficients:\n",
       "             Estimate Std. Error t value Pr(>|t|)    \n",
       "(Intercept) 0.3168726  0.1416113   2.238   0.0253 *  \n",
       "treatment   0.8015271  0.1711683   4.683 2.84e-06 ***\n",
       "history     0.0013288  0.0003309   4.016 5.94e-05 ***\n",
       "---\n",
       "Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1\n",
       "\n",
       "Residual standard error: 15.1 on 31884 degrees of freedom\n",
       "Multiple R-squared:  0.001379,\tAdjusted R-squared:  0.001316 \n",
       "F-statistic: 22.02 on 2 and 31884 DF,  p-value: 2.786e-10\n"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "summary(biased_reg)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Coefficients以外の情報を気にしないためtidyを利用する\n",
    "library(\"broom\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "metadata": {},
   "outputs": [],
   "source": [
    "biased_reg_coef <- tidy(biased_reg)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 3 × 5</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>term</th><th scope=col>estimate</th><th scope=col>std.error</th><th scope=col>statistic</th><th scope=col>p.value</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>(Intercept)</td><td>0.316872573</td><td>0.1416113104</td><td>2.237622</td><td>2.525260e-02</td></tr>\n",
       "\t<tr><td>treatment  </td><td>0.801527140</td><td>0.1711683204</td><td>4.682684</td><td>2.843080e-06</td></tr>\n",
       "\t<tr><td>history    </td><td>0.001328774</td><td>0.0003308897</td><td>4.015762</td><td>5.938966e-05</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 3 × 5\n",
       "\\begin{tabular}{lllll}\n",
       " term & estimate & std.error & statistic & p.value\\\\\n",
       " <chr> & <dbl> & <dbl> & <dbl> & <dbl>\\\\\n",
       "\\hline\n",
       "\t (Intercept) & 0.316872573 & 0.1416113104 & 2.237622 & 2.525260e-02\\\\\n",
       "\t treatment   & 0.801527140 & 0.1711683204 & 4.682684 & 2.843080e-06\\\\\n",
       "\t history     & 0.001328774 & 0.0003308897 & 4.015762 & 5.938966e-05\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 3 × 5\n",
       "\n",
       "| term &lt;chr&gt; | estimate &lt;dbl&gt; | std.error &lt;dbl&gt; | statistic &lt;dbl&gt; | p.value &lt;dbl&gt; |\n",
       "|---|---|---|---|---|\n",
       "| (Intercept) | 0.316872573 | 0.1416113104 | 2.237622 | 2.525260e-02 |\n",
       "| treatment   | 0.801527140 | 0.1711683204 | 4.682684 | 2.843080e-06 |\n",
       "| history     | 0.001328774 | 0.0003308897 | 4.015762 | 5.938966e-05 |\n",
       "\n"
      ],
      "text/plain": [
       "  term        estimate    std.error    statistic p.value     \n",
       "1 (Intercept) 0.316872573 0.1416113104 2.237622  2.525260e-02\n",
       "2 treatment   0.801527140 0.1711683204 4.682684  2.843080e-06\n",
       "3 history     0.001328774 0.0003308897 4.015762  5.938966e-05"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "biased_reg_coef"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "効果検証のための回帰分析は$\\beta_{treatment}$以外の推定結果には興味はないため、介入効果を示すパラメータ以外は無視することになる。"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 回帰分析におけるバイアス"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "metadata": {},
   "outputs": [],
   "source": [
    "# RCTデータでの単回帰\n",
    "rct_reg <- lm(data = male_df, formula = spend ~ treatment)\n",
    "rct_reg_coef <- summary(rct_reg) %>% tidy()\n",
    "\n",
    "# バイアスのあるデータでの単回帰\n",
    "nonrct_reg <- lm(data = biased_data, formula = spend ~ treatment)\n",
    "nonrct_reg_coef <- summary(nonrct_reg) %>% tidy()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 35,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 5</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>term</th><th scope=col>estimate</th><th scope=col>std.error</th><th scope=col>statistic</th><th scope=col>p.value</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>(Intercept)</td><td>0.6527894</td><td>0.1027070</td><td>6.355841</td><td>2.093808e-10</td></tr>\n",
       "\t<tr><td>treatment  </td><td>0.7698272</td><td>0.1452479</td><td>5.300090</td><td>1.163201e-07</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 5\n",
       "\\begin{tabular}{lllll}\n",
       " term & estimate & std.error & statistic & p.value\\\\\n",
       " <chr> & <dbl> & <dbl> & <dbl> & <dbl>\\\\\n",
       "\\hline\n",
       "\t (Intercept) & 0.6527894 & 0.1027070 & 6.355841 & 2.093808e-10\\\\\n",
       "\t treatment   & 0.7698272 & 0.1452479 & 5.300090 & 1.163201e-07\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 5\n",
       "\n",
       "| term &lt;chr&gt; | estimate &lt;dbl&gt; | std.error &lt;dbl&gt; | statistic &lt;dbl&gt; | p.value &lt;dbl&gt; |\n",
       "|---|---|---|---|---|\n",
       "| (Intercept) | 0.6527894 | 0.1027070 | 6.355841 | 2.093808e-10 |\n",
       "| treatment   | 0.7698272 | 0.1452479 | 5.300090 | 1.163201e-07 |\n",
       "\n"
      ],
      "text/plain": [
       "  term        estimate  std.error statistic p.value     \n",
       "1 (Intercept) 0.6527894 0.1027070 6.355841  2.093808e-10\n",
       "2 treatment   0.7698272 0.1452479 5.300090  1.163201e-07"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "rct_reg_coef"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 36,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 2 × 5</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>term</th><th scope=col>estimate</th><th scope=col>std.error</th><th scope=col>statistic</th><th scope=col>p.value</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>(Intercept)</td><td>0.5893892</td><td>0.1243217</td><td>4.740841</td><td>2.137509e-06</td></tr>\n",
       "\t<tr><td>treatment  </td><td>0.8957021</td><td>0.1695944</td><td>5.281436</td><td>1.290146e-07</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 2 × 5\n",
       "\\begin{tabular}{lllll}\n",
       " term & estimate & std.error & statistic & p.value\\\\\n",
       " <chr> & <dbl> & <dbl> & <dbl> & <dbl>\\\\\n",
       "\\hline\n",
       "\t (Intercept) & 0.5893892 & 0.1243217 & 4.740841 & 2.137509e-06\\\\\n",
       "\t treatment   & 0.8957021 & 0.1695944 & 5.281436 & 1.290146e-07\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 2 × 5\n",
       "\n",
       "| term &lt;chr&gt; | estimate &lt;dbl&gt; | std.error &lt;dbl&gt; | statistic &lt;dbl&gt; | p.value &lt;dbl&gt; |\n",
       "|---|---|---|---|---|\n",
       "| (Intercept) | 0.5893892 | 0.1243217 | 4.740841 | 2.137509e-06 |\n",
       "| treatment   | 0.8957021 | 0.1695944 | 5.281436 | 1.290146e-07 |\n",
       "\n"
      ],
      "text/plain": [
       "  term        estimate  std.error statistic p.value     \n",
       "1 (Intercept) 0.5893892 0.1243217 4.740841  2.137509e-06\n",
       "2 treatment   0.8957021 0.1695944 5.281436  1.290146e-07"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "nonrct_reg_coef"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "共変量がない場合、バイアスが加味されており高く評価されてしまった。\n",
    "次に共変量Xをモデルに加えてみる。以下の式にしてみるとどうなるか。\n",
    "$$\n",
    "Spend_i = \\beta_0 + \\beta_{treatment}treatment_i + \\beta_{recency}recency_i + \\beta_{channel}channel_i + \\beta_{history}history_i + u_i\n",
    "$$"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 37,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<table class=\"dataframe\">\n",
       "<caption>A tibble: 6 × 5</caption>\n",
       "<thead>\n",
       "\t<tr><th scope=col>term</th><th scope=col>estimate</th><th scope=col>std.error</th><th scope=col>statistic</th><th scope=col>p.value</th></tr>\n",
       "\t<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>\n",
       "</thead>\n",
       "<tbody>\n",
       "\t<tr><td>(Intercept) </td><td> 0.470266673</td><td>0.3702582964</td><td> 1.27010435</td><td>2.040567e-01</td></tr>\n",
       "\t<tr><td>treatment   </td><td> 0.738858871</td><td>0.1751833668</td><td> 4.21763141</td><td>2.475628e-05</td></tr>\n",
       "\t<tr><td>recency     </td><td>-0.046354508</td><td>0.0254244602</td><td>-1.82322486</td><td>6.827870e-02</td></tr>\n",
       "\t<tr><td>channelPhone</td><td> 0.028505964</td><td>0.2976346680</td><td> 0.09577501</td><td>9.236999e-01</td></tr>\n",
       "\t<tr><td>channelWeb  </td><td> 0.329227001</td><td>0.2969198519</td><td> 1.10880764</td><td>2.675215e-01</td></tr>\n",
       "\t<tr><td>history     </td><td> 0.001283275</td><td>0.0003688548</td><td> 3.47907774</td><td>5.038141e-04</td></tr>\n",
       "</tbody>\n",
       "</table>\n"
      ],
      "text/latex": [
       "A tibble: 6 × 5\n",
       "\\begin{tabular}{lllll}\n",
       " term & estimate & std.error & statistic & p.value\\\\\n",
       " <chr> & <dbl> & <dbl> & <dbl> & <dbl>\\\\\n",
       "\\hline\n",
       "\t (Intercept)  &  0.470266673 & 0.3702582964 &  1.27010435 & 2.040567e-01\\\\\n",
       "\t treatment    &  0.738858871 & 0.1751833668 &  4.21763141 & 2.475628e-05\\\\\n",
       "\t recency      & -0.046354508 & 0.0254244602 & -1.82322486 & 6.827870e-02\\\\\n",
       "\t channelPhone &  0.028505964 & 0.2976346680 &  0.09577501 & 9.236999e-01\\\\\n",
       "\t channelWeb   &  0.329227001 & 0.2969198519 &  1.10880764 & 2.675215e-01\\\\\n",
       "\t history      &  0.001283275 & 0.0003688548 &  3.47907774 & 5.038141e-04\\\\\n",
       "\\end{tabular}\n"
      ],
      "text/markdown": [
       "\n",
       "A tibble: 6 × 5\n",
       "\n",
       "| term &lt;chr&gt; | estimate &lt;dbl&gt; | std.error &lt;dbl&gt; | statistic &lt;dbl&gt; | p.value &lt;dbl&gt; |\n",
       "|---|---|---|---|---|\n",
       "| (Intercept)  |  0.470266673 | 0.3702582964 |  1.27010435 | 2.040567e-01 |\n",
       "| treatment    |  0.738858871 | 0.1751833668 |  4.21763141 | 2.475628e-05 |\n",
       "| recency      | -0.046354508 | 0.0254244602 | -1.82322486 | 6.827870e-02 |\n",
       "| channelPhone |  0.028505964 | 0.2976346680 |  0.09577501 | 9.236999e-01 |\n",
       "| channelWeb   |  0.329227001 | 0.2969198519 |  1.10880764 | 2.675215e-01 |\n",
       "| history      |  0.001283275 | 0.0003688548 |  3.47907774 | 5.038141e-04 |\n",
       "\n"
      ],
      "text/plain": [
       "  term         estimate     std.error    statistic   p.value     \n",
       "1 (Intercept)   0.470266673 0.3702582964  1.27010435 2.040567e-01\n",
       "2 treatment     0.738858871 0.1751833668  4.21763141 2.475628e-05\n",
       "3 recency      -0.046354508 0.0254244602 -1.82322486 6.827870e-02\n",
       "4 channelPhone  0.028505964 0.2976346680  0.09577501 9.236999e-01\n",
       "5 channelWeb    0.329227001 0.2969198519  1.10880764 2.675215e-01\n",
       "6 history       0.001283275 0.0003688548  3.47907774 5.038141e-04"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# バイアスのあるデータでの単回帰\n",
    "nonrct_mreg <- lm(data = biased_data, formula = spend ~ treatment + recency + channel + history)\n",
    "nonrct_mreg_coef <- summary(nonrct_mreg) %>% tidy()\n",
    "nonrct_mreg_coef"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "treatmentの数字が小さくなったため、共変量によりバイアスの影響が少なくなった。\n",
    "\n",
    "「セレクションバイアスの影響をより小さくするために、どのような共変量をモデルに追加すべきか」\n",
    "=> 「目的変数Yと介入変数Zに対して相関のある変数を加えるべき」"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "R",
   "language": "R",
   "name": "ir"
  },
  "language_info": {
   "codemirror_mode": "r",
   "file_extension": ".r",
   "mimetype": "text/x-r-source",
   "name": "R",
   "pygments_lexer": "r",
   "version": "4.0.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
